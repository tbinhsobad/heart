<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Animated Heart</title>
<style>
    body {
        background: black;
        margin: 0;
        overflow: hidden;
    }
    canvas {
        display: block;
    }
</style>
</head>
<body>

<canvas id="heartCanvas"></canvas>

<script>
// --- FULL SCREEN ---
const canvas = document.getElementById("heartCanvas");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const CANVAS_WIDTH = canvas.width;
const CANVAS_HEIGHT = canvas.height;
const CENTER_X = CANVAS_WIDTH / 2;
const CENTER_Y = CANVAS_HEIGHT / 2;

// --- HEART BIGGER (tăng lên 20 thay vì 11) ---
const HEART_COLOR = "#ff9eb5";
const IMAGE_ENLARGE = 20;  

const ctx = canvas.getContext("2d");

function heartFunction(t, shrinkRatio = IMAGE_ENLARGE) {
    let x = 16 * Math.pow(Math.sin(t), 3);
    let y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));

    x *= shrinkRatio;
    y *= shrinkRatio;

    x += CENTER_X;
    y += CENTER_Y;
    return [x, y];
}

function scatterInside(x, y, beta = 0.15) {
    let ratioX = -beta * Math.log(Math.random());
    let ratioY = -beta * Math.log(Math.random());
    let dx = ratioX * (x - CENTER_X);
    let dy = ratioY * (y - CENTER_Y);
    return [x - dx, y - dy];
}

function shrink(x, y, ratio) {
    let force = -1 / Math.pow((Math.pow(x - CENTER_X, 2) + Math.pow(y - CENTER_Y, 2)), 0.6);
    let dx = ratio * force * (x - CENTER_X);
    let dy = ratio * force * (y - CENTER_Y);
    return [x - dx, y - dy];
}

function curve(p) {
    return (2 * (2 * Math.sin(4 * p))) / (2 * Math.PI);
}

class Heart {
    constructor(frames = 20) {
        this.frames = frames;
        this.points = [];
        this.edgePoints = [];
        this.centerPoints = [];
        this.allFrames = {};

        this.build(2500);

        for (let f = 0; f < this.frames; f++) {
            this.calc(f);
        }
    }

    build(n) {
        for (let i = 0; i < n; i++) {
            let t = Math.random() * Math.PI * 2;
            let [x, y] = heartFunction(t);
            this.points.push([x, y]);
        }

        for (let [x0, y0] of this.points) {
            for (let i = 0; i < 3; i++) {
                this.edgePoints.push(scatterInside(x0, y0, 0.05));
            }
        }

        for (let i = 0; i < 5000; i++) {
            let [x, y] = this.points[Math.floor(Math.random() * this.points.length)];
            this.centerPoints.push(scatterInside(x, y, 0.17));
        }
    }

    calcFramePosition(x, y, ratio) {
        let force = 1 / Math.pow(((x - CENTER_X) ** 2 + (y - CENTER_Y) ** 2), 0.52);
        let dx = ratio * force * (x - CENTER_X) + (Math.random() * 2 - 1);
        let dy = ratio * force * (y - CENTER_Y) + (Math.random() * 2 - 1);
        return [x - dx, y - dy];
    }

    calc(frame) {
        let ratio = 8 * curve((frame / 10) * Math.PI); // giảm ratio cho chậm lại
        let haloRadius = Math.floor(5 + 8 * (1 + curve((frame / 10) * Math.PI)));
        let haloCount = Math.floor(3500 + 4500 * Math.abs(Math.pow(curve((frame / 10) * Math.PI), 2)));

        let all = [];

        for (let i = 0; i < haloCount; i++) {
            let t = Math.random() * Math.PI * 2;
            let [x, y] = heartFunction(t, IMAGE_ENLARGE * 1.05);
            [x, y] = shrink(x, y, haloRadius);
            x += Math.floor(Math.random() * 26 - 13);
            y += Math.floor(Math.random() * 26 - 13);
            let size = Math.random() < 0.3 ? 2 : 1;
            all.push([x, y, size]);
        }

        for (let [x, y] of this.points) {
            [x, y] = this.calcFramePosition(x, y, ratio);
            let size = 1 + Math.floor(Math.random() * 2);
            all.push([x, y, size]);
        }

        for (let [x, y] of this.edgePoints) {
            [x, y] = this.calcFramePosition(x, y, ratio);
            let size = 1 + Math.floor(Math.random() * 2);
            all.push([x, y, size]);
        }

        for (let [x, y] of this.centerPoints) {
            [x, y] = this.calcFramePosition(x, y, ratio);
            let size = 1 + Math.floor(Math.random() * 2);
            all.push([x, y, size]);
        }

        this.allFrames[frame] = all;
    }

    render(frame) {
        ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        for (let [x, y, size] of this.allFrames[frame % this.frames]) {
            ctx.fillStyle = HEART_COLOR;
            ctx.fillRect(x, y, size, size);
        }
    }
}

let heart = new Heart(20);
let frame = 0;

// --- CHẠY CHẬM LẠI ---
function animate() {
    heart.render(frame++);
    setTimeout(() => requestAnimationFrame(animate), 40); // từ 0ms -> 40ms (chậm 40%)
}

animate();
</script>
</body>
</html>
